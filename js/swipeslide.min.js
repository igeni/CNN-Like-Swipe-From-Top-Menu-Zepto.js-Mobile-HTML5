/**
 * @author SwipeSlide - Tegan Snyder, Github.com/tegansnyder - (http://www.tegdesign.com)
 *
 * Ideas for touch implementation taken from jQuery touchwipe. I started with it as a base and stripped it down just for purpose of wipeUp and wipeDown. I also tweaked it to work with Zepto.js. Then added a bunch of new configurable features plus some scrolling event greatness.
 *
 * @author jQuery touchwipe - Andreas Waltl, netCU Internetagentur (http://www.netcu.de)
 */
 
(function ($) {

    $.fn.swipeslide = function (settings) {

        var config = {
            min_move_y: Math.abs(parseInt($('#swipemenu nav').css('top').split('px')[0], 10)),
            swipe_menu: '#swipemenu',
			puller: '#puller',
            nav_container: 'nav',
            menu_btns_container: 'aside',
            navEvent: 'click',
			pullerEvent: 'click'
        };

        if (settings) $.extend(config, settings);

        this.each(function () {

            var startY;
            var isMoving = false;

            function cancelTouch() {
                this.removeEventListener('touchmove', onTouchMove);
                this.removeEventListener('touchend', onTouchEnd);
                startX = null;
                isMoving = false;
            }

            function onTouchMove(e) {

                if (isMoving) {

                    var y = e.touches[0].pageY;
                    var dy = startY - y;

                    if (Math.abs(dy) >= config.min_move_y) {

                        if (dy < 0) {

                            $(config.swipe_menu).css('top', '319px');
                            $(config.swipe_menu + ' ' + config.nav_container).css('top', '-319px');

                        } else {

                            $(config.swipe_menu + ' ' + config.menu_btns_container).show();

                            $(config.swipe_menu + ' ' + config.nav_container).css('top', '-319px');
                            $(config.swipe_menu).css('top', '-40px');
                            $(config.swipe_menu).removeClass('swipemenu-dragged').addClass('swipemenu-rested');

                            $(config.puller).removeClass('puller-dragged').addClass('puller-rested');
                            $('.puller-rested').css('top', '26px');

                        }

                        cancelTouch();

                    } else {

                        if (dy > 0) {

                            dy = Math.abs(parseInt($(config.swipe_menu + ' ' + config.nav_container).css('top').split('px')[0], 10)) - dy;

                            $(config.swipe_menu + ' ' + config.nav_container).removeClass('dragging-down').addClass('dragging-up');

                            $(config.swipe_menu).css('top', Math.abs(dy) + 'px');
                            $(config.swipe_menu).removeClass('swipemenu-rested').addClass('swipemenu-dragged');

                            $(config.puller).removeClass('puller-rested').addClass('puller-dragged');

                        } else {

                            $(config.swipe_menu + ' ' + config.menu_btns_container).hide();

                            $(config.swipe_menu + ' ' + config.nav_container).removeClass('dragging-up').addClass('dragging-down');

                            $(config.swipe_menu).css('top', Math.abs(dy) + 'px');
                            $(config.swipe_menu).removeClass('swipemenu-rested').addClass('swipemenu-dragged');
                            $(config.puller).css('top', '0px');
                            $(config.puller).removeClass('puller-rested').addClass('puller-dragged');

                        }

                    }

                }
            }

            function onTouchStart(e) {

                if (e.touches.length == 1) {

                    startY = e.touches[0].pageY;
                    isMoving = true;

                    this.addEventListener('touchmove', onTouchMove, false);
                    this.addEventListener('touchend', onTouchEnd, false);

                    $(config.swipe_menu).on(config.navEvent, config.nav_container + ' ul li a', onNavEvent);

                }

            }

            function onTouchEnd(e) {
			
				document.addEventListener('scroll', onScroll, false);

                if (Math.abs(parseInt($(config.swipe_menu).css('top').split('px')[0], 10)) >= (config.min_move_y / 2)) {

                    if ($(config.swipe_menu + ' ' + config.nav_container).hasClass('dragging-down')) {

                        openMenu(false);

                    } else {

                        closeMenu();
                    }

                } else {

                    closeMenu();
                }

                cancelTouch();

            }

            function onScroll(e) {

                $(config.swipe_menu).css('top', config.min_move_y + getPageScroll()[1] + 'px');

            }

            function onNavEvent(e) {

                closeMenu();

            }
			
			function onPullerEvent(e) {
			
				if ($(config.swipe_menu).hasClass('swipemenu-dragged')) {
				
					closeMenu();
					
				} else {
				
					openMenu(true);
				
				}
			
			}

			function openMenu(static_open) {
			
				if (static_open) {
					$(config.swipe_menu + ' ' + config.menu_btns_container).hide();

					$(config.swipe_menu + ' ' + config.nav_container).removeClass('dragging-up').addClass('dragging-down');

					$(config.swipe_menu).css('top', config.min_move_y + 'px');
					$(config.swipe_menu).removeClass('swipemenu-rested').addClass('swipemenu-dragged');
					$(config.puller).css('top', '0px');
					$(config.puller).removeClass('puller-rested').addClass('puller-dragged');
				}
			
				$(config.swipe_menu).css('top', '319px');
				$(config.swipe_menu + ' ' + config.nav_container).css('top', '-319px');
			
			}
			
            function closeMenu() {

                $(config.swipe_menu + ' ' + config.menu_btns_container).show();

                $(config.swipe_menu + ' ' + config.nav_container).css('top', '-319px');
                $(config.swipe_menu).css('top', '-40px');
                $(config.swipe_menu).removeClass('swipemenu-dragged').addClass('swipemenu-rested');

                $(config.puller).removeClass('puller-dragged').addClass('puller-rested');
                $('.puller-rested').css('top', '26px');

				document.removeEventListener('scroll', onScroll, false);
                $(config.swipe_menu).off(config.navEvent, config.nav_container + ' ul li a');

            }

            function getPageScroll() {

                var xScroll, yScroll;

                if (self.pageYOffset) {

                    yScroll = self.pageYOffset;
                    xScroll = self.pageXOffset;

                } else if (document.documentElement && document.documentElement.scrollTop) {

                    yScroll = document.documentElement.scrollTop;
                    xScroll = document.documentElement.scrollLeft;

                } else if (document.body) {

                    yScroll = document.body.scrollTop;
                    xScroll = document.body.scrollLeft;

                }

                return new Array(xScroll, yScroll);

            }

            this.addEventListener('touchstart', onTouchStart, false);
			
			$(document).on(config.pullerEvent, config.puller, onPullerEvent);

        });

        return this;
    };

})($);